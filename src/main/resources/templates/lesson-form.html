<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${title} ?: 'Занятие'">Занятие</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/app.css}">

</head>
<body>
<nav th:replace="fragments/navbar :: main-navbar"></nav>


<div class="container mt-4" th:with="edit=${isEdit}">
    <h1 th:text="${title}">Занятие</h1>

    <form th:action="${isEdit} ? @{'/lessons/' + ${lessonForm.id}} : @{/lessons}"
          th:object="${lessonForm}"
          method="post"
          class="mt-3">

        <!-- CSRF -->
        <input type="hidden"
               th:name="${_csrf.parameterName}"
               th:value="${_csrf.token}"/>

        <!-- Глобальные ошибки валидации (пересечения по времени и т.п.) -->
        <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger">
            <div th:each="err : ${#fields.globalErrors()}"
                 th:text="${err}">Ошибка</div>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label" for="date">Дата</label>
                <input type="date" id="date" th:field="*{date}" class="form-control">
                <div class="text-danger" th:if="${#fields.hasErrors('date')}"
                     th:errors="*{date}"></div>
            </div>

            <div class="col-md-4">
                <label class="form-label" for="startTime">Время начала</label>
                <select id="startTime" th:field="*{startTime}" class="form-select">
                    <option th:each="t : ${defaultStartTimes}"
                            th:value="${t}"
                            th:text="${#temporals.format(t, 'HH:mm')}">
                    </option>
                </select>
                <div class="text-danger" th:if="${#fields.hasErrors('startTime')}"
                     th:errors="*{startTime}"></div>
            </div>

            <div class="col-md-4">
                <label class="form-label" for="endTime">Время окончания</label>
                <input type="time" id="endTime" th:field="*{endTime}" class="form-control">
                <div class="form-text">
                    Занятие должно длиться 1 час 30 минут.
                </div>
                <div class="text-danger" th:if="${#fields.hasErrors('endTime')}"
                     th:errors="*{endTime}"></div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label" for="groupId">Группа</label>
                <select id="groupId" th:field="*{groupId}" class="form-select">
                    <option th:value="${null}">— выберите группу —</option>
                    <option th:each="g : ${groups}"
                            th:value="${g.id}"
                            th:text="${g.code + ' — ' + g.name}">
                    </option>
                </select>
                <div class="text-danger" th:if="${#fields.hasErrors('groupId')}"
                     th:errors="*{groupId}"></div>
            </div>

            <div class="col-md-6">
                <label class="form-label" for="subjectId">Дисциплина</label>
                <select id="subjectId" th:field="*{subjectId}" class="form-select">
                    <option th:value="${null}">— выберите дисциплину —</option>
                    <option th:each="s : ${subjects}"
                            th:value="${s.id}"
                            th:text="${s.code + ' — ' + s.name}">
                    </option>
                </select>
                <div class="text-danger" th:if="${#fields.hasErrors('subjectId')}"
                     th:errors="*{subjectId}"></div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label" for="teacherId">Преподаватель</label>
                <select id="teacherId" th:field="*{teacherId}" class="form-select">
                    <option th:value="${null}">— выберите преподавателя —</option>
                    <option th:each="t : ${teachers}"
                            th:value="${t.id}"
                            th:text="${t.fullName}">
                    </option>
                </select>
                <div class="text-danger" th:if="${#fields.hasErrors('teacherId')}"
                     th:errors="*{teacherId}"></div>
            </div>

            <div class="col-md-6">
                <label class="form-label" for="roomId">Аудитория</label>
                <select id="roomId" th:field="*{roomId}" class="form-select">
                    <option th:value="${null}">— выберите аудиторию —</option>
                    <option th:each="r : ${rooms}"
                            th:value="${r.id}"
                            th:text="${r.code}">
                    </option>
                </select>
                <div class="text-danger" th:if="${#fields.hasErrors('roomId')}"
                     th:errors="*{roomId}"></div>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label" for="type">Тип занятия</label>
            <input type="text" id="type" th:field="*{type}" class="form-control"
                   placeholder="Например: обычное занятие, мастер-класс">
            <div class="text-danger" th:if="${#fields.hasErrors('type')}"
                 th:errors="*{type}"></div>
        </div>

        <div class="mb-3">
            <label class="form-label" for="notes">Примечание / тема</label>
            <textarea id="notes" th:field="*{notes}" class="form-control" rows="3"></textarea>
            <div class="text-danger" th:if="${#fields.hasErrors('notes')}"
                 th:errors="*{notes}"></div>
        </div>

        <button type="submit" class="btn btn-primary">
            <span th:text="${isEdit} ? 'Сохранить изменения' : 'Создать занятие'">
                Сохранить
            </span>
        </button>
        <a class="btn btn-secondary"
           th:href="@{/lessons(date=${lessonForm.date})}">
            Отмена
        </a>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>

<script th:inline="javascript">
    // простая синхронизация окончания: старт + 90 минут
    const startSelect = document.getElementById('startTime');
    const endInput = document.getElementById('endTime');

    function recalcEnd() {
        if (!startSelect || !endInput || !startSelect.value) {
            return;
        }
        const [h, m] = startSelect.value.split(':').map(Number);
        if (isNaN(h) || isNaN(m)) return;

        let startMinutes = h * 60 + m;
        let endMinutes = startMinutes + 90;

        let eh = Math.floor(endMinutes / 60);
        let em = endMinutes % 60;

        if (eh >= 24) eh -= 24;

        const pad = (x) => x.toString().padStart(2, '0');
        endInput.value = pad(eh) + ':' + pad(em);
    }

    if (startSelect) {
        startSelect.addEventListener('change', recalcEnd);
        // если создаём новое занятие, можно сразу подставить конец
        /*<![CDATA[*/
        const isEdit = /*[[${isEdit}]]*/ false;
        if (!isEdit) {
            recalcEnd();
        }
        /*]]>*/
    }
</script>
</body>
</html>
